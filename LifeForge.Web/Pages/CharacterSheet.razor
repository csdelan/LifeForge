@page "/"
@page "/character"
@using LifeForge.Domain
@using LifeForge.Web.Services
@inject CharacterService CharacterService

<PageTitle>Character Sheet</PageTitle>

<div class="character-sheet">
    <h1>Character Sheet</h1>

    @if (isLoading)
    {
        <p><em>Loading character...</em></p>
    }
    else if (_character != null)
    {
        <div class="character-info">
            <h2>@_character.Name</h2>

            <div class="stats-grid">
                <div class="stat-section">
                    <h3>Attributes</h3>
                    <div class="stat-row">
                        <span class="stat-label">Strength:</span>
                        <span class="stat-value">@_character.Strength</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Discipline:</span>
                        <span class="stat-value">@_character.Discipline</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Focus:</span>
                        <span class="stat-value">@_character.Focus</span>
                    </div>
                </div>

                <div class="stat-section">
                    <h3>Resources</h3>
                    <div class="resource-bar">
                        <label>HP</label>
                        <div class="progress-bar">
                            <div class="progress-background hp-background"></div>
                            <div class="progress-fill hp-fill" style="width: @GetHPPercentage()%"></div>
                            <span class="progress-text">@_character.HP / @_character.HPMax</span>
                        </div>
                    </div>
                    <div class="resource-bar">
                        <label>MP</label>
                        <div class="progress-bar">
                            <div class="progress-background mp-background"></div>
                            <div class="progress-fill mp-fill" style="width: @GetMPPercentage()%"></div>
                            <span class="progress-text">@_character.MP / @_character.MPMax</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wealth-section">
                <h3>Wealth</h3>
                <div class="currency-list">
                    @if (_character.Currencies.Any())
                    {
                        @foreach (var currency in _character.Currencies)
                        {
                            <div class="currency-item">
                                <span class="currency-name">@currency.Key:</span>
                                <span class="currency-amount">@currency.Value</span>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="no-data">No currencies yet</p>
                    }
                </div>
            </div>

            <div class="classes-section">
                <h3>Classes</h3>
                <div class="class-list">
                    @if (_character.ClassProfiles.Any())
                    {
                        @foreach (var classProfile in _character.ClassProfiles)
                        {
                            <div class="class-item">
                                <h4>@classProfile.Value.ClassName</h4>
                                <div class="class-details">
                                    <span>Level: @classProfile.Value.Level</span>
                                    <div class="xp-bar">
                                        <div class="progress-bar small">
                                            <div class="progress-fill xp-fill" style="width: @GetXPPercentage(classProfile.Value)%"></div>
                                            <span class="progress-text small">@classProfile.Value.CurrentXp / @classProfile.Value.XpToNextLevel</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="no-data">No classes yet</p>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <h4><span class="bi bi-info-circle"></span> No Character Yet</h4>
            <p>Complete your first quest to create your character and start earning rewards!</p>
            <a href="/quests" class="btn btn-primary">Go to Quests</a>
        </div>
    }
</div>

@code {
    private Models.CharacterDto? _character;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCharacter();
    }

    private async Task LoadCharacter()
    {
        try
        {
            isLoading = true;
            _character = await CharacterService.GetCharacterAsync();
        }
        catch (Exception ex)
        {
            // Character doesn't exist yet - that's okay
            Console.WriteLine($"No character found: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private double GetHPPercentage()
    {
        if (_character == null || _character.HPMax == 0) return 0;
        return ((double)_character.HP / _character.HPMax) * 100;
    }

    private double GetMPPercentage()
    {
        if (_character == null || _character.MPMax == 0) return 0;
        return ((double)_character.MP / _character.MPMax) * 100;
    }

    private double GetXPPercentage(Models.CharacterClassDto classSnapshot)
    {
        if (classSnapshot.XpToNextLevel == 0) return 100;
        return ((double)classSnapshot.CurrentXp / classSnapshot.XpToNextLevel) * 100;
    }
}
