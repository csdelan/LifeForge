@page "/"
@page "/character"
@using LifeForge.Domain
@using LifeForge.Web.Services
@using LifeForge.Web.Models
@inject CharacterService CharacterService
@inject BuffInstanceService BuffInstanceService
@inject IJSRuntime JSRuntime

<PageTitle>Character Sheet</PageTitle>

<div class="character-sheet">
    <h1>Character Sheet</h1>

    @if (isLoading)
    {
        <p><em>Loading character...</em></p>
    }
    else if (_character != null)
    {
        <div class="character-info">
            <h2>@_character.Name</h2>

            <div class="stats-grid">
                <div class="stat-section">
                    <h3>Attributes</h3>
                    <div class="stat-row">
                        <span class="stat-label">Strength:</span>
                        <span class="stat-value">@_character.Strength</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Discipline:</span>
                        <span class="stat-value">@_character.Discipline</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Focus:</span>
                        <span class="stat-value">@_character.Focus</span>
                    </div>
                </div>

                <div class="stat-section">
                    <h3>Resources</h3>
                    <div class="resource-bar">
                        <label>HP</label>
                        <div class="progress-bar">
                            <div class="progress-background hp-background"></div>
                            <div class="progress-fill hp-fill" style="width: @GetHPPercentage()%"></div>
                            <span class="progress-text">@_character.HP / @_character.HPMax</span>
                        </div>
                    </div>
                    <div class="resource-bar">
                        <label>MP</label>
                        <div class="progress-bar">
                            <div class="progress-background mp-background"></div>
                            <div class="progress-fill mp-fill" style="width: @GetMPPercentage()%"></div>
                            <span class="progress-text">@_character.MP / @_character.MPMax</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wealth-section">
                <h3>Wealth</h3>
                <div class="currency-list">
                    @if (_character.Currencies.Any())
                    {
                        @foreach (var currency in _character.Currencies)
                        {
                            <div class="currency-item">
                                <span class="currency-name">@currency.Key:</span>
                                <span class="currency-amount">@currency.Value</span>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="no-data">No currencies yet</p>
                    }
                </div>
            </div>

            <div class="classes-section">
                <h3>Classes</h3>
                <div class="class-list">
                    @if (_character.ClassProfiles.Any())
                    {
                        @foreach (var classProfile in _character.ClassProfiles)
                        {
                            <div class="class-item">
                                <h4>@classProfile.Value.ClassName</h4>
                                <div class="class-details">
                                    <span>Level: @classProfile.Value.Level</span>
                                    <div class="xp-bar">
                                        <div class="progress-bar small">
                                            <div class="progress-fill xp-fill" style="width: @GetXPPercentage(classProfile.Value)%"></div>
                                            <span class="progress-text small">@classProfile.Value.CurrentXp / @classProfile.Value.XpToNextLevel</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="no-data">No classes yet</p>
                    }
                </div>
            </div>

            <div class="buffs-section">
                <h3>Active Buffs/Debuffs</h3>
                @if (isLoadingBuffs)
                {
                    <p><em>Loading active buffs...</em></p>
                }
                else if (activeBuffs.Any())
                {
                    <div class="active-buffs-gallery">
                        @foreach (var buff in activeBuffs)
                        {
                            <div class="active-buff-card @(buff.IsDebuff ? "debuff-card" : "buff-card")">
                                <div class="active-buff-image">
                                    @if (!string.IsNullOrEmpty(buff.ImageData))
                                    {
                                        <img src="@GetImageDataUrl(buff.ImageData, buff.ImageContentType)" alt="@buff.BuffName" />
                                    }
                                    else
                                    {
                                        <div class="active-buff-placeholder">
                                            <span class="bi @(buff.IsDebuff ? "bi-arrow-down-circle" : "bi-arrow-up-circle")"></span>
                                        </div>
                                    }
                                    @if (buff.Stacks > 1)
                                    {
                                        <div class="active-buff-stacks-badge">x@buff.Stacks</div>
                                    }
                                </div>
                                <div class="active-buff-info">
                                    <div class="active-buff-name">@buff.BuffName</div>
                                    <div class="active-buff-timer">
                                        <span class="bi bi-clock"></span>
                                        @GetBuffTimeRemaining(buff)
                                    </div>
                                </div>
                                <button class="btn-end-buff" @onclick="() => EndBuff(buff)" title="End Buff">
                                    <span class="bi bi-x-lg"></span>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="no-data">No active buffs</p>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <h4><span class="bi bi-info-circle"></span> No Character Yet</h4>
            <p>Complete your first quest to create your character and start earning rewards!</p>
            <a href="/quests" class="btn btn-primary">Go to Quests</a>
        </div>
    }
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}

@code {
    private Models.CharacterDto? _character;
    private List<BuffInstanceDto> activeBuffs = new();
    private bool isLoading = true;
    private bool isLoadingBuffs = true;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCharacter();
        await LoadActiveBuffs();
    }

    private async Task LoadCharacter()
    {
        try
        {
            isLoading = true;
            _character = await CharacterService.GetCharacterAsync();
        }
        catch (Exception ex)
        {
            // Character doesn't exist yet - that's okay
            Console.WriteLine($"No character found: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadActiveBuffs()
    {
        try
        {
            isLoadingBuffs = true;
            if (_character != null && !string.IsNullOrEmpty(_character.Id))
            {
                activeBuffs = await BuffInstanceService.GetActiveBuffInstancesByCharacterIdAsync(_character.Id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading active buffs: {ex.Message}");
        }
        finally
        {
            isLoadingBuffs = false;
        }
    }

    private async Task EndBuff(BuffInstanceDto buff)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to end '{buff.BuffName}'?"))
        {
            return;
        }

        try
        {
            var result = await BuffInstanceService.DeactivateBuffInstanceAsync(_character!.Id!, buff.Id!);
            
            if (result != null && result.Success)
            {
                var modifiersText = result.ModifiersApplied.Any() 
                    ? " Removed: " + string.Join(", ", result.ModifiersApplied.Select(m => $"{m.Key} {(m.Value > 0 ? "+" : "")}{m.Value}"))
                    : "";
                successMessage = $"Buff '{buff.BuffName}' ended!{modifiersText}";
                
                // Reload character and buffs
                await LoadCharacter();
                await LoadActiveBuffs();
            }
            else
            {
                errorMessage = result?.ErrorMessage ?? "Failed to end buff";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error ending buff: {ex.Message}";
        }
    }

    private string GetBuffTimeRemaining(BuffInstanceDto buff)
    {
        var remaining = buff.EndTime - DateTime.UtcNow;
        if (remaining.TotalDays >= 1)
            return $"{(int)remaining.TotalDays}d";
        if (remaining.TotalHours >= 1)
            return $"{(int)remaining.TotalHours}h";
        if (remaining.TotalMinutes >= 1)
            return $"{(int)remaining.TotalMinutes}m";
        return "Expiring soon";
    }

    private string GetImageDataUrl(string? imageData, string? contentType)
    {
        if (string.IsNullOrEmpty(imageData))
            return string.Empty;
        
        var mimeType = !string.IsNullOrEmpty(contentType) ? contentType : "image/jpeg";
        return $"data:{mimeType};base64,{imageData}";
    }

    private double GetHPPercentage()
    {
        if (_character == null || _character.HPMax == 0) return 0;
        return ((double)_character.HP / _character.HPMax) * 100;
    }

    private double GetMPPercentage()
    {
        if (_character == null || _character.MPMax == 0) return 0;
        return ((double)_character.MP / _character.MPMax) * 100;
    }

    private double GetXPPercentage(Models.CharacterClassDto classSnapshot)
    {
        if (classSnapshot.XpToNextLevel == 0) return 100;
        return ((double)classSnapshot.CurrentXp / classSnapshot.XpToNextLevel) * 100;
    }
}
