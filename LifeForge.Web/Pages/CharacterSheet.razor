@page "/"
@page "/character"
@using LifeForge.Domain
@using LifeForge.Web.Services
@using LifeForge.Web.Models
@inject CharacterService CharacterService
@inject BuffInstanceService BuffInstanceService
@inject ActionService ActionService
@inject IJSRuntime JSRuntime

<PageTitle>Character Sheet</PageTitle>

<div class="character-sheet">
    <h1>Character Sheet</h1>

    @if (isLoading)
    {
        <p><em>Loading character...</em></p>
    }
    else if (_character != null)
    {
        <div class="character-info">
            <h2>@_character.Name</h2>

            <div class="stats-grid">
                <div class="stat-section">
                    <h3>Attributes</h3>
                    <div class="stat-row">
                        <span class="stat-label">Strength:</span>
                        <span class="stat-value">@_character.Strength</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Discipline:</span>
                        <span class="stat-value">@_character.Discipline</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Focus:</span>
                        <span class="stat-value">@_character.Focus</span>
                    </div>
                </div>

                <div class="stat-section">
                    <h3>Resources</h3>
                    <div class="resource-bar">
                        <label>HP</label>
                        <div class="progress-bar">
                            <div class="progress-background hp-background"></div>
                            <div class="progress-fill hp-fill" style="width: @GetHPPercentage()%"></div>
                            <span class="progress-text">@((int)_character.HP) / @((int)_character.HPMax)</span>
                        </div>
                    </div>
                    <div class="resource-bar">
                        <label>MP</label>
                        <div class="progress-bar">
                            <div class="progress-background mp-background"></div>
                            <div class="progress-fill mp-fill" style="width: @GetMPPercentage()%"></div>
                            <span class="progress-text">@((int)_character.MP) / @((int)_character.MPMax)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wealth-section">
                <h3>Wealth</h3>
                <div class="currency-list">
                    @if (_character.Currencies.Any())
                    {
                        @foreach (var currency in _character.Currencies)
                        {
                            <div class="currency-item">
                                <span class="currency-name">@currency.Key:</span>
                                <span class="currency-amount">@currency.Value</span>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="no-data">No currencies yet</p>
                    }
                </div>
            </div>

            <div class="classes-section">
                <h3>Classes</h3>
                <div class="class-list">
                    @if (_character.ClassProfiles.Any())
                    {
                        @foreach (var classProfile in _character.ClassProfiles)
                        {
                            <div class="class-item">
                                <h4>@classProfile.Value.ClassName</h4>
                                <div class="class-details">
                                    <span>Level: @classProfile.Value.Level</span>
                                    <div class="xp-bar">
                                        <div class="progress-bar small">
                                            <div class="progress-fill xp-fill" style="width: @GetXPPercentage(classProfile.Value)%"></div>
                                            <span class="progress-text small">@classProfile.Value.CurrentXp / @classProfile.Value.XpToNextLevel</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="no-data">No classes yet</p>
                    }
                </div>
            </div>

            <div class="buffs-section">
                <h3>Active Buffs/Debuffs</h3>
                @if (isLoadingBuffs)
                {
                    <p><em>Loading active buffs...</em></p>
                }
                else if (activeBuffs.Any())
                {
                    <div class="active-buffs-gallery">
                        @foreach (var buff in activeBuffs)
                        {
                            <div class="active-buff-card @(buff.IsDebuff ? "debuff-card" : "buff-card")" 
                                 title="@GetBuffTooltip(buff)">
                                <div class="active-buff-image">
                                    @if (!string.IsNullOrEmpty(buff.ImageData))
                                    {
                                        <img src="@GetImageDataUrl(buff.ImageData, buff.ImageContentType)" alt="@buff.BuffName" />
                                    }
                                    else
                                    {
                                        <div class="active-buff-placeholder">
                                            <span class="bi @(buff.IsDebuff ? "bi-arrow-down-circle" : "bi-arrow-up-circle")"></span>
                                        </div>
                                    }
                                    @if (buff.Stacks > 1)
                                    {
                                        <div class="active-buff-stacks-badge">x@(buff.Stacks)</div>
                                    }
                                </div>
                                <div class="active-buff-info">
                                    <div class="active-buff-name">@buff.BuffName</div>
                                    <div class="active-buff-timer">
                                        <span class="bi bi-clock"></span>
                                        @GetBuffTimeRemaining(buff)
                                    </div>
                                </div>
                                <button class="btn-end-buff" @onclick="() => EndBuff(buff)" title="End Buff">
                                    <span class="bi bi-x-lg"></span>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="no-data">No active buffs</p>
                }
            </div>

            <div class="actions-section">
                <h3>Common Actions</h3>
                <div class="actions-list">
                    <div class="action-item">
                        <div class="action-info">
                            <span class="action-icon">??</span>
                            <div class="action-details">
                                <div class="action-name">Drink Alcoholic Beverage</div>
                                <div class="action-description">Drink an alcoholic drink, resulting in Hangover and Alcohol Detoxing effects</div>
                            </div>
                        </div>
                        <button class="btn-execute-action" @onclick="DrinkAlcoholicDrink" disabled="@isPerformingAction" title="Execute this action">
                            <span class="bi bi-play-circle-fill"></span>
                            Execute
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <h4><span class="bi bi-info-circle"></span> No Character Yet</h4>
            <p>Complete your first quest to create your character and start earning rewards!</p>
            <a href="/quests" class="btn btn-primary">Go to Quests</a>
        </div>
    }
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}

@code {
    private Models.CharacterDto? _character;
    private List<BuffInstanceDto> activeBuffs = new();
    private bool isLoading = true;
    private bool isLoadingBuffs = true;
    private bool isPerformingAction = false;
    private string? errorMessage;
    private string? successMessage;
    private string? drinkActionId;
    private string? hangoverBuffId;
    private string? detoxBuffId;

    protected override async Task OnInitializedAsync()
    {
        await LoadCharacter();
        await LoadActiveBuffs();
        await InitializeActions();
    }

    private async Task InitializeActions()
    {
        // This will be called to set up the action IDs
        // In a real scenario, you'd load these from the database
        // For now, we'll create them if they don't exist
    }

    private async Task DrinkAlcoholicDrink()
    {
        if (_character == null || string.IsNullOrEmpty(_character.Id))
        {
            errorMessage = "No character found";
            return;
        }

        try
        {
            isPerformingAction = true;
            
            // Manually activate the Hangover and Alcohol Detoxing buffs
            // First, try to find these buffs in the system
            var buffService = new BuffService(new HttpClient { BaseAddress = new Uri("https://localhost:7001") });
            var allBuffs = await buffService.GetAllBuffsAsync();
            
            var hangoverBuff = allBuffs.FirstOrDefault(b => b.Name == "Hangover");
            var detoxBuff = allBuffs.FirstOrDefault(b => b.Name == "Alcohol Detoxing");
            
            if (hangoverBuff == null || detoxBuff == null)
            {
                errorMessage = "Required buffs (Hangover and Alcohol Detoxing) not found. Please create them first.";
                return;
            }

            // Activate both buffs
            var hangoverResult = await BuffInstanceService.ActivateBuffAsync(_character.Id, hangoverBuff.Id!);
            var detoxResult = await BuffInstanceService.ActivateBuffAsync(_character.Id, detoxBuff.Id!);

            if (hangoverResult?.Success == true && detoxResult?.Success == true)
            {
                successMessage = "?? You drank an alcoholic beverage! Effects: Hangover and Alcohol Detoxing activated.";
                await LoadCharacter();
                await LoadActiveBuffs();
            }
            else
            {
                errorMessage = "Failed to apply drinking effects. " + (hangoverResult?.ErrorMessage ?? detoxResult?.ErrorMessage ?? "");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error performing action: {ex.Message}";
        }
        finally
        {
            isPerformingAction = false;
        }
    }

    private string GetDrinkActionTooltip()
    {
        return @"Drink an alcoholic beverage

This action will activate two buffs:
• Hangover (negative effects)
• Alcohol Detoxing (recovery process)

Note: Make sure these buffs exist in your buff library.";
    }

    private async Task LoadCharacter()
    {
        try
        {
            isLoading = true;
            _character = await CharacterService.GetCharacterAsync();
        }
        catch (Exception ex)
        {
            // Character doesn't exist yet - that's okay
            Console.WriteLine($"No character found: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadActiveBuffs()
    {
        try
        {
            isLoadingBuffs = true;
            if (_character != null && !string.IsNullOrEmpty(_character.Id))
            {
                activeBuffs = await BuffInstanceService.GetActiveBuffInstancesByCharacterIdAsync(_character.Id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading active buffs: {ex.Message}");
        }
        finally
        {
            isLoadingBuffs = false;
        }
    }

    private async Task EndBuff(BuffInstanceDto buff)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to end '{buff.BuffName}'?"))
        {
            return;
        }

        try
        {
            var result = await BuffInstanceService.DeactivateBuffInstanceAsync(_character!.Id!, buff.Id!);
            
            if (result != null && result.Success)
            {
                var modifiersText = result.ModifiersApplied.Any() 
                    ? " Removed: " + string.Join(", ", result.ModifiersApplied.Select(m => $"{m.Key} {(m.Value > 0 ? "+" : "")}{m.Value}"))
                    : "";
                successMessage = $"Buff '{buff.BuffName}' ended!{modifiersText}";
                
                // Reload character and buffs
                await LoadCharacter();
                await LoadActiveBuffs();
            }
            else
            {
                errorMessage = result?.ErrorMessage ?? "Failed to end buff";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error ending buff: {ex.Message}";
        }
    }

    private string GetBuffTimeRemaining(BuffInstanceDto buff)
    {
        var remaining = buff.EndTime - DateTime.UtcNow;
        if (remaining.TotalDays >= 1)
            return $"{(int)remaining.TotalDays}d";
        if (remaining.TotalHours >= 1)
            return $"{(int)remaining.TotalHours}h";
        if (remaining.TotalMinutes >= 1)
            return $"{(int)remaining.TotalMinutes}m";
        return "Expiring soon";
    }

    private string GetBuffTooltip(BuffInstanceDto buff)
    {
        var tooltip = new System.Text.StringBuilder();
        
        // Add buff name
        tooltip.AppendLine(buff.BuffName);
        
        // Add description if available
        if (!string.IsNullOrEmpty(buff.Description))
        {
            tooltip.AppendLine();
            tooltip.AppendLine(buff.Description);
        }
        
        // Calculate total modifiers across all stacks
        var stacks = buff.Stacks;
        
        // Add modifiers section (showing total across all stacks)
        var modifiers = new List<string>();
        
        if (buff.HPModifier != 0)
            modifiers.Add($"HP {FormatModifier(buff.HPModifier * stacks)} (per stack: {FormatModifier(buff.HPModifier)})");
        if (buff.HPMaxModifier != 0)
            modifiers.Add($"HP Max {FormatModifier(buff.HPMaxModifier * stacks)} (per stack: {FormatModifier(buff.HPMaxModifier)})");
        if (buff.HPPercentModifier != 0)
            modifiers.Add($"HP {FormatModifier(buff.HPPercentModifier * stacks)}% (per stack: {FormatModifier(buff.HPPercentModifier)}%)");
        if (buff.HPMaxPercentModifier != 0)
            modifiers.Add($"HP Max {FormatModifier(buff.HPMaxPercentModifier * stacks)}% (per stack: {FormatModifier(buff.HPMaxPercentModifier)}%)");
        if (buff.MPModifier != 0)
            modifiers.Add($"MP {FormatModifier(buff.MPModifier * stacks)} (per stack: {FormatModifier(buff.MPModifier)})");
        if (buff.MPMaxModifier != 0)
            modifiers.Add($"MP Max {FormatModifier(buff.MPMaxModifier * stacks)} (per stack: {FormatModifier(buff.MPMaxModifier)})");
        if (buff.MPPercentModifier != 0)
            modifiers.Add($"MP {FormatModifier(buff.MPPercentModifier * stacks)}% (per stack: {FormatModifier(buff.MPPercentModifier)}%)");
        if (buff.MPMaxPercentModifier != 0)
            modifiers.Add($"MP Max {FormatModifier(buff.MPMaxPercentModifier * stacks)}% (per stack: {FormatModifier(buff.MPMaxPercentModifier)}%)");
        if (buff.XpGainsPercentModifier != 0)
            modifiers.Add($"XP Gains {FormatModifier(buff.XpGainsPercentModifier * stacks)}% (per stack: {FormatModifier(buff.XpGainsPercentModifier)}%)");
        
        if (modifiers.Any())
        {
            tooltip.AppendLine();
            if (stacks > 1)
            {
                tooltip.AppendLine($"Total Modifiers (x{stacks} stacks):");
            }
            else
            {
                tooltip.AppendLine("Modifiers:");
            }
            foreach (var modifier in modifiers)
            {
                tooltip.AppendLine($"  {modifier}");
            }
        }
        
        // Add stacks info if > 1
        if (buff.Stacks > 1)
        {
            tooltip.AppendLine();
            tooltip.AppendLine($"Active Stacks: {buff.Stacks}");
        }
        
        return tooltip.ToString().TrimEnd();
    }

    private string FormatModifier(int value)
    {
        return value > 0 ? $"+{value}" : value.ToString();
    }

    private string GetImageDataUrl(string? imageData, string? contentType)
    {
        if (string.IsNullOrEmpty(imageData))
            return string.Empty;
        
        var mimeType = !string.IsNullOrEmpty(contentType) ? contentType : "image/jpeg";
        return $"data:{mimeType};base64,{imageData}";
    }

    private double GetHPPercentage()
    {
        if (_character == null || _character.HPMax == 0) return 0;
        return (double)(_character.HP / _character.HPMax) * 100;
    }

    private double GetMPPercentage()
    {
        if (_character == null || _character.MPMax == 0) return 0;
        return (double)(_character.MP / _character.MPMax) * 100;
    }

    private double GetXPPercentage(Models.CharacterClassDto classSnapshot)
    {
        if (classSnapshot.XpToNextLevel == 0) return 100;
        return ((double)classSnapshot.CurrentXp / classSnapshot.XpToNextLevel) * 100;
    }
}
