# Daily Buff Processing System Architecture

## System Flow Diagram

```
???????????????????????????????????????????????????????????????????????????????
?                           USER ACTIONS                                       ?
???????????????????????????????????????????????????????????????????????????????
                                    ?
                         ???????????????????????
                         ?                     ?
                    [Activate Buff]      [Deactivate Buff]
                         ?                     ?
                         ?                     ?
            ??????????????????????    ????????????????????????
            ? Create Buff        ?    ? Delete Buff          ?
            ? Instance           ?    ? Instance             ?
            ? Status: Pending    ?    ? (Immediate)          ?
            ? StartTime: Now     ?    ?                      ?
            ? EndTime: +N days   ?    ? Recalculate          ?
            ??????????????????????    ? Aggregates           ?
                         ?            ? (Immediate)          ?
                         ?            ????????????????????????
            ??????????????????????????????????????????????????
            ?         MongoDB: buffInstances                 ?
            ?  { status: "Pending", endTime: ... }          ?
            ??????????????????????????????????????????????????
                         ?
                         ? Waits until midnight...
                         ?
                         ?
???????????????????????????????????????????????????????????????????????????????
?                    MIDNIGHT JOB (12:00 AM UTC)                              ?
?                  MidnightBuffProcessingService                              ?
???????????????????????????????????????????????????????????????????????????????
                         ?
           ?????????????????????????????
           ?             ?             ?
     [Step 1]      [Step 2]      [Step 3]
  Activate Pending  Expire Old   Recalculate
      Buffs           Buffs      Aggregates
           ?             ?             ?
           ?             ?             ?
    ????????????  ????????????  ??????????????????
    ? Status:  ?  ? Status:  ?  ? Sum all Active ?
    ? Pending  ?  ? Active   ?  ? buff modifiers ?
    ?    ?     ?  ?    ?     ?  ?                ?
    ? Active   ?  ? Expired  ?  ? Group by       ?
    ????????????  ????????????  ? BuffId         ?
                                 ?                ?
                                 ? Take first N   ?
                                 ? (MaxStacks)    ?
                                 ?                ?
                                 ? Update:        ?
                                 ? Character.     ?
                                 ? ActiveBuff     ?
                                 ? Modifiers      ?
                                 ??????????????????
                                         ?
                                         ?
            ??????????????????????????????????????????????????
            ?      MongoDB: characters                       ?
            ?  { activeBuffModifiers: {                     ?
            ?      hpMaxModifier: 30,                       ?
            ?      mpModifier: 10, ...                      ?
            ?  }}                                           ?
            ??????????????????????????????????????????????????
                                         ?
                                         ?
                                         ?
???????????????????????????????????????????????????????????????????????????????
?                         DISPLAY LAYER                                        ?
?                      CharacterSheet.razor                                    ?
???????????????????????????????????????????????????????????????????????????????
                                         ?
                    ???????????????????????????????????????????
                    ?                                         ?
              [Base Stats]                            [Effective Stats]
            (from database)                        (calculated on-the-fly)
                    ?                                         ?
                    ?                                         ?
         ????????????????????                   ???????????????????????????
         ? HP: 50           ?                   ? EffectiveHP =           ?
         ? HPMax: 100       ?                   ?   HP + HPModifier +     ?
         ? MP: 30           ?                   ?   (HP * HPPercent/100)  ?
         ? MPMax: 80        ?                   ?                         ?
         ????????????????????                   ? = min(result,           ?
                                                ?       EffectiveHPMax)   ?
         ????????????????????                   ?                         ?
         ? ActiveBuff       ?                   ? EffectiveHPMax =        ?
         ? Modifiers:       ?  ?????????????>   ?   HPMax + HPMaxMod +    ?
         ?   HPMod: +10     ?                   ?   (HPMax * HPMaxPct/100)?
         ?   HPPct: 0       ?                   ?                         ?
         ?   HPMaxMod: +20  ?                   ? Result:                 ?
         ?   HPMaxPct: +10  ?                   ?   EffectiveHPMax = 132  ?
         ????????????????????                   ?   EffectiveHP = 50      ?
                                                ???????????????????????????
                                                           ?
                                                           ?
                                                   ??????????????????
                                                   ?  Display:      ?
                                                   ?  HP: 50/132    ?
                                                   ?  (Buffed)      ?
                                                   ??????????????????
```

## Data Model Relationships

```
???????????????????????????????????????????????????????????????????????????????
?                               Buff                                           ?
?  (Template/Definition)                                                       ?
???????????????????????????????????????????????????????????????????????????????
? - Name: "Strength Boost"                                                    ?
? - MaxStacks: 3                                                              ?
? - DurationDays: 7                                                           ?
? - HPMaxModifier: +10                                                        ?
? - Trigger: Manual                                                           ?
???????????????????????????????????????????????????????????????????????????????
                                   ?
                                   ? User clicks "Activate"
                                   ?
                                   ?
         ???????????????????????????????????????????????????????????
         ?              BuffInstance (Active Instance)              ?
         ???????????????????????????????????????????????????????????
         ? - BuffId: -> Buff                                       ?
         ? - CharacterId: -> Character                             ?
         ? - Status: Pending ? Active ? Expired                    ?
         ? - StartTime: 2024-01-01 18:00:00                       ?
         ? - EndTime: 2024-01-08 18:00:00 (StartTime + 7 days)   ?
         ? - Stacks: 1                                             ?
         ? - HPMaxModifier: 10 (copied from Buff)                 ?
         ???????????????????????????????????????????????????????????
                                 ?
                                 ? Multiple instances can exist
                                 ? (independent expiration)
                                 ?
                                 ?
??????????????????????????????????????????????????????????????????????????????
?                            Character                                        ?
??????????????????????????????????????????????????????????????????????????????
? BASE STATS (UN-BUFFED):                                                    ?
? - HP: 50                                                                   ?
? - HPMax: 100                                                               ?
? - MP: 30                                                                   ?
? - MPMax: 80                                                                ?
?                                                                            ?
? AGGREGATE MODIFIERS (from all Active buffs):                              ?
? - ActiveBuffModifiers: {                                                  ?
?     HPModifier: 0                                                         ?
?     HPMaxModifier: 30      ? Sum of 3 active buff instances              ?
?     HPPercentModifier: 0                                                  ?
?     HPMaxPercentModifier: 0                                               ?
?     MPModifier: 0                                                         ?
?     MPMaxModifier: 0                                                      ?
?     MPPercentModifier: 0                                                  ?
?     MPMaxPercentModifier: 0                                               ?
?     XpGainsPercentModifier: 0                                             ?
?   }                                                                        ?
?                                                                            ?
? COMPUTED PROPERTIES (for display):                                        ?
? - EffectiveHP: 50          (calculated from base + modifiers)            ?
? - EffectiveHPMax: 130      (calculated from base + modifiers)            ?
? - EffectiveMP: 30                                                         ?
? - EffectiveMPMax: 80                                                      ?
??????????????????????????????????????????????????????????????????????????????
```

## Buff Status Lifecycle

```
                                    ?????????????????????
                                    ?  User Activates   ?
                                    ?      Buff         ?
                                    ?????????????????????
                                              ?
                                              ?
                                    ?????????????????????
                                    ?    ? PENDING     ?
                                    ?                   ?
                                    ? Waiting for next  ?
                                    ?  midnight job     ?
                                    ?????????????????????
                                              ?
                                Midnight job runs
                                              ?
                                              ?
                                    ?????????????????????
                                    ?    ? ACTIVE      ?
                                    ?                   ?
                                    ? Contributing to   ?
                                    ?   aggregates      ?
                                    ?                   ?
                                    ? Displayed on UI   ?
                                    ?????????????????????
                                              ?
                          ?????????????????????????????????????????
                          ?                                       ?
                Time passes (EndTime reached)          User clicks "End Buff"
                          ?                                       ?
            Midnight job runs                                     ?
                          ?                                       ?
                          ?                                       ?
                ?????????????????????                 ????????????????????
                ?   ? EXPIRED      ?                 ?    ?? DELETED    ?
                ?                   ?                 ?                  ?
                ? No longer         ?                 ? Immediately      ?
                ? contributing      ?                 ? removed          ?
                ?                   ?                 ?                  ?
                ? Will be deleted   ?                 ? Aggregates       ?
                ? after 7 days      ?                 ? recalculated     ?
                ?????????????????????                 ????????????????????
                          ?
            After 7 days, midnight job
                          ?
                          ?
                ????????????????????
                ?   ?? DELETED     ?
                ?                  ?
                ? Cleanup removes  ?
                ? from database    ?
                ????????????????????
```

## Aggregation Logic Flow

```
                        ????????????????????????????????????????
                        ? BuffAggregationService               ?
                        ? CalculateAggregateModifiersAsync()   ?
                        ????????????????????????????????????????
                                       ?
                                       ?
                        ????????????????????????????????????????
                        ? 1. Query all BuffInstances           ?
                        ?    WHERE CharacterId = X             ?
                        ?    AND Status = Active               ?
                        ????????????????????????????????????????
                                       ?
                                       ?
                        ????????????????????????????????????????
                        ? 2. Group by BuffId                   ?
                        ?                                      ?
                        ? BuffId: A                            ?
                        ?   Instance 1 (oldest)                ?
                        ?   Instance 2                         ?
                        ?   Instance 3                         ?
                        ?   Instance 4                         ?
                        ?   Instance 5 (newest)                ?
                        ?                                      ?
                        ? BuffId: B                            ?
                        ?   Instance 1                         ?
                        ????????????????????????????????????????
                                       ?
                                       ?
                        ????????????????????????????????????????
                        ? 3. For each BuffId group:            ?
                        ?                                      ?
                        ? Get MaxStacks from Buff definition   ?
                        ? (e.g., MaxStacks = 3)                ?
                        ?                                      ?
                        ? Sort instances by StartTime (oldest  ?
                        ? first)                               ?
                        ?                                      ?
                        ? Take(MaxStacks) ? first 3 instances  ?
                        ?                                      ?
                        ? Ignore remaining instances           ?
                        ????????????????????????????????????????
                                       ?
                                       ?
                        ????????????????????????????????????????
                        ? 4. For each effective instance:      ?
                        ?                                      ?
                        ? Multiply modifiers by Stacks         ?
                        ? (usually Stacks = 1 per instance)    ?
                        ?                                      ?
                        ? Instance 1: HPMaxMod = 10 * 1 = 10   ?
                        ? Instance 2: HPMaxMod = 10 * 1 = 10   ?
                        ? Instance 3: HPMaxMod = 10 * 1 = 10   ?
                        ????????????????????????????????????????
                                       ?
                                       ?
                        ????????????????????????????????????????
                        ? 5. Sum all modifiers into            ?
                        ?    AggregateModifier:                ?
                        ?                                      ?
                        ? HPMaxModifier = 10 + 10 + 10 = 30    ?
                        ? MPModifier = ...                     ?
                        ? XpGainsPercentModifier = ...         ?
                        ????????????????????????????????????????
                                       ?
                                       ?
                        ????????????????????????????????????????
                        ? 6. Update Character entity:          ?
                        ?    ActiveBuffModifiers = aggregate   ?
                        ?                                      ?
                        ? Save to database                     ?
                        ????????????????????????????????????????
```

## Example: Multiple Buffs with Stacking

```
Character has:
  - HP: 100 (base)
  - HPMax: 200 (base)

Active Buffs:
????????????????????????????????????????????????????????????????????
? Buff A: "Vigor" (MaxStacks: 3)                                   ?
?   Instance 1: HPMaxModifier = +10, StartTime = Day 1            ?
?   Instance 2: HPMaxModifier = +10, StartTime = Day 2            ?
?   Instance 3: HPMaxModifier = +10, StartTime = Day 3            ?
?   Instance 4: HPMaxModifier = +10, StartTime = Day 4 ? IGNORED  ?
?                                                                  ?
? Buff B: "Strength" (MaxStacks: 1)                               ?
?   Instance 1: HPMaxModifier = +20, StartTime = Day 1            ?
?                                                                  ?
? Buff C: "Recovery" (MaxStacks: 2)                               ?
?   Instance 1: HPModifier = +5, StartTime = Day 1                ?
?   Instance 2: HPModifier = +5, StartTime = Day 2                ?
????????????????????????????????????????????????????????????????????

Aggregation Calculation:
????????????????????????????????????????????????????????????????????
Buff A: Take first 3 instances (MaxStacks = 3)
  HPMaxModifier: 10 + 10 + 10 = 30

Buff B: Take first 1 instance (MaxStacks = 1)
  HPMaxModifier: 20

Buff C: Take first 2 instances (MaxStacks = 2)
  HPModifier: 5 + 5 = 10

Total Aggregate:
  HPModifier: 10
  HPMaxModifier: 50 (30 + 20)

Effective Stats:
????????????????????????????????????????????????????????????????????
EffectiveHPMax = HPMax + HPMaxModifier
               = 200 + 50
               = 250

EffectiveHP = min(HP + HPModifier, EffectiveHPMax)
            = min(100 + 10, 250)
            = 110

Displayed on UI: HP 110 / 250
```

## Component Interaction Diagram

```
???????????????         ????????????????????         ????????????????????
?   Blazor    ?         ?   API            ?         ?   Background     ?
?   Web UI    ?         ?   Controllers    ?         ?   Service        ?
???????????????         ????????????????????         ????????????????????
       ?                         ?                            ?
       ? POST /activate          ?                            ?
       ?????????????????????????>?                            ?
       ?                         ?                            ?
       ?                         ? Create BuffInstance        ?
       ?                         ? (Status: Pending)          ?
       ?                         ?                            ?
       ? 201 Created             ?                            ?
       ?<?????????????????????????                            ?
       ?                         ?                            ?
       ?                         ?                            ?
       ? [User clicks            ?                            ?
       ?  Manual Trigger]        ?                            ?
       ?                         ?                            ?
       ? POST /trigger           ?                            ?
       ?????????????????????????>?                            ?
       ?                         ?                            ?
       ?                         ? Invoke ProcessBuffsAsync() ?
       ?                         ????????????????????????????>?
       ?                         ?                            ?
       ?                         ?                   Activate Pending
       ?                         ?                   Expire Old
       ?                         ?                   Recalculate Aggregates
       ?                         ?                            ?
       ?                         ? 200 OK                     ?
       ?                         ?<????????????????????????????
       ? 200 OK                  ?                            ?
       ?<?????????????????????????                            ?
       ?                         ?                            ?
       ? GET /characters         ?                            ?
       ?????????????????????????>?                            ?
       ?                         ?                            ?
       ?                         ? Read from MongoDB          ?
       ?                         ? Calculate Effective Stats  ?
       ?                         ?                            ?
       ? CharacterDto            ?                            ?
       ? (with effective stats)  ?                            ?
       ?<?????????????????????????                            ?
       ?                         ?                            ?
       ? Render UI               ?                            ?
       ? (show buffed values)    ?                            ?
       ?                         ?                            ?
       ?                         ?                            ?
       ?                         ?                [Midnight]  ?
       ?                         ?                            ?
       ?                         ?          Auto-trigger      ?
       ?                         ?          ProcessBuffsAsync()
       ?                         ?                            ?
       ?                         ?                  Process all characters
       ?                         ?                  Update aggregates
       ?                         ?                            ?
```

## Performance Considerations

```
?????????????????????????????????????????????????????????????????????
?                    Performance Metrics                            ?
?????????????????????????????????????????????????????????????????????
?                                                                   ?
?  MongoDB Queries per Midnight Job:                               ?
?  ?????????????????????????????????????????????????????????????   ?
?  1. GetAllCharactersAsync()           ? 1 query                  ?
?  2. GetPendingBuffInstancesAsync()    ? 1 query per character    ?
?  3. GetExpiredBuffInstancesAsync()    ? 1 query per character    ?
?  4. BulkUpdateStatusAsync()           ? 1 query per character    ?
?  5. UpdateCharacterAsync()            ? 1 query per character    ?
?                                                                   ?
?  Total: 1 + (4 * N characters)                                   ?
?                                                                   ?
?  Example: 100 characters = 401 queries                           ?
?  Time: ~10 seconds (assuming 25ms per query)                     ?
?                                                                   ?
?????????????????????????????????????????????????????????????????????
?                                                                   ?
?  Optimization Opportunities:                                      ?
?  ?????????????????????????????????????????????????????????????   ?
?  ? Bulk operations (UpdateMany) reduce round trips              ?
?  ? Indexes on characterId, status, endTime                      ?
?  ? Sequential processing (not parallel) = predictable memory    ?
?  ? Future: Batch multiple characters per transaction            ?
?  ? Future: Cache buff definitions                               ?
?                                                                   ?
?????????????????????????????????????????????????????????????????????
```

## Security & Access Control

```
?????????????????????????????????????????????????????????????????????
?                    Access Control Matrix                          ?
?????????????????????????????????????????????????????????????????????
?                                                                   ?
?  Endpoint                              ? Access Level            ?
?  ?????????????????????????????????????????????????????????????   ?
?  POST /api/buffinstances/activate      ? User (their character) ?
?  POST /api/buffinstances/deactivate    ? User (their character) ?
?  POST /api/buffprocessing/trigger      ? ANY (dev only)         ?
?                                         ? ? Remove in prod       ?
?  Midnight Job (internal)                ? System (internal)      ?
?                                                                   ?
?????????????????????????????????????????????????????????????????????
?                                                                   ?
?  Future Enhancements:                                             ?
?  ?????????????????????????????????????????????????????????????   ?
?  ? Add API key to trigger endpoint                              ?
?  ? Add authorization checks (user can only modify own character)?
?  ? Add rate limiting to prevent buff spam                       ?
?  ? Add audit log for buff activations/deactivations             ?
?                                                                   ?
?????????????????????????????????????????????????????????????????????
```

This architecture provides a scalable, maintainable solution for daily buff processing with clear separation of concerns and predictable behavior.
